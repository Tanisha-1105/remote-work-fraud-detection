<!-- templates/admin_dashboard.html -->
{% extends "base.html" %}
{% block title %}Admin Dashboard - TrueLensAI{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <div class="brand-icon admin me-2">
                <i class="bi bi-shield-lock-fill"></i>
            </div>
            <span class="fw-bold">TrueLensAI</span>
            <span class="text-light opacity-50 ms-2 small">/ Admin Console</span>
        </a>

        <div class="d-flex align-items-center">
            <a href="{{ url_for('employee_management') }}" class="btn btn-outline-info btn-sm me-3">
                <i class="bi bi-people me-1"></i> Manage Employees
            </a>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-light btn-sm">
                <i class="bi bi-box-arrow-right me-1"></i> Logout
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid py-4 bg-light min-vh-100">
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-start border-danger border-4 h-100">
                <div class="card-body">
                    <p class="text-muted small mb-1">Critical Alerts</p>
                    <h2 class="mb-1" id="critical-alerts-count">{{ stats.critical_alerts }}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <p class="text-muted small mb-1">Total Employees</p>
                    <h2 class="mb-1">{{ stats.total_employees }}</h2>
                    <small class="text-muted">
                        <span id="active-employees-count">{{ stats.active_employees }}</span> currently active
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <p class="text-muted small mb-1">Avg Productivity</p>
                    <h2 class="mb-1" id="avg-productivity-score">{{ stats.avg_productivity|round(1) }}%</h2>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <p class="opacity-75 small mb-1">System Status</p>
                    <h2 class="mb-1">Active</h2>
                </div>
            </div>
        </div>

    </div>

    <div class="row g-4">

        <div class="col-lg-8">
            <div class="card">

                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Suspicious Activity Feed</h5>
                        <small class="text-muted">Real-time anomalies detected by Isolation Forest</small>
                    </div>
                    <div>
                        <a href="{{ url_for('alerts') }}" class="btn btn-outline-primary btn-sm me-2">
                            <i class="bi bi-list"></i> View All
                        </a>
                        <a href="{{ url_for('export_data') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-download"></i> Export CSV
                        </a>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="risk-employee-table">
                        <thead class="table-light">
                            <tr>
                                <th>Employee</th>
                                <th>Risk Score</th>
                                <th>Alert Level</th>
                                <th class="text-end">Action</th>
                            </tr>
                        </thead>

                        <tbody id="employee-risk-data">

                        {% for employee in employees_at_risk %}
                            <tr id="employee-row-{{ employee.id }}" class="align-middle">

                                <td>
                                    <strong>{{ employee.name }}</strong><br>
                                    <small class="text-muted">{{ employee.role }}</small>
                                </td>

                                <td>
                                    <span class="fw-bold {% if employee.latest_risk_score >= 80 %} text-danger {% elif employee.latest_risk_score >= 50 %} text-warning {% else %} text-success {% endif %}">
                                        {{ employee.latest_risk_score|round(0) }}%
                                    </span>

                                    <div class="progress mt-1" style="height:6px;">
                                        <div class="progress-bar {% if employee.latest_risk_score >= 80 %} bg-danger {% elif employee.latest_risk_score >= 50 %} bg-warning {% else %} bg-success {% endif %}"
                                            style="width: {{ employee.latest_risk_score }}%;">
                                        </div>
                                    </div>
                                </td>

                                <td>
                                    <span class="badge {% if employee.alert_level == 'High' %} bg-danger {% elif employee.alert_level == 'Medium' %} bg-warning text-dark {% else %} bg-success {% endif %}">
                                        {{ employee.alert_level }}
                                    </span>
                                </td>

                                <td><small class="text-muted">Active</small></td>

                                <td class="text-end">
                                    <button onclick="sendWarning({{ employee.id }}, '{{ employee.name }}')" class="btn btn-sm btn-danger me-2">
                                        <i class="bi bi-exclamation-triangle me-1"></i> Warn
                                    </button>
                                    <button onclick="requestScreenShare({{ employee.id }}, '{{ employee.name }}')" class="btn btn-sm btn-info me-2">
                                        <i class="bi bi-display me-1"></i> Screen Share
                                    </button>
                                    <a href="{{ url_for('employee_activity_report', employee_id=employee.id) }}"
                                       class="btn btn-sm btn-outline-secondary">
                                        Review Report
                                    </a>
                                </td>

                            </tr>
                        {% endfor %}

                        </tbody>

                    </table>
                </div>

            </div>
        </div>

        <div class="col-lg-4">

            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Anomaly Trend</h5>
                    <small class="text-muted">Hourly activity over the last 7 days</small>
                </div>
                <div class="card-body">
                    <canvas id="anomalyChart" height="200"></canvas>
                </div>
            </div>

        </div>

    </div>

</div>

<div class="modal fade" id="screenShareModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Live Screen: <span id="employeeNameSpan"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center bg-light">
                <video id="remoteVideo" autoplay playsinline muted style="width:100%; max-height:70vh; background:#000; border:1px solid #ccc;"></video>
                <p id="connectionStatus" class="mt-3 text-danger">Awaiting connection...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// SOCKET.IO & WEBRTC SETUP
const socket = io();
const STUN_SERVERS = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
let peerConnection = null;
let currentEmployeeId = null;
let pendingIce = [];

//Initiate Admin Side WebRTC
function startAdminWebRTC(employeeId) {
    if (peerConnection) peerConnection.close(); 
    
    currentEmployeeId = employeeId;

    peerConnection = new RTCPeerConnection(STUN_SERVERS);
    peerConnection.addTransceiver("video", { direction: "recvonly" });
    
    // Handle ICE Candidates from Admin side -> Send to Employee
    peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
            socket.emit('webrtc_signal', {
                type: 'ice',
                sender_id: 'admin',
                receiver_id: employeeId,
                payload: event.candidate
            });
        }
    };
 
    //Handle incoming video stream
    peerConnection.ontrack = (event) => {
        const video = document.getElementById("remoteVideo");
        video.srcObject = event.streams[0];
        video.play().catch(e => console.error("Video play error:", e));
        
        const status = document.getElementById("connectionStatus");
        status.textContent = "Live screen connected";
        status.className = "mt-3 text-success";
    };

    createOffer(employeeId);
}

//Create Offer
async function createOffer(employeeId) {
    try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        socket.emit("webrtc_signal", {
            type: "offer",
            sender_id: "admin",
            receiver_id: employeeId,
            payload: offer
        });
        document.getElementById("connectionStatus").textContent = "Offer sent. Waiting for employee...";
    } catch(err) {
        console.error("Error creating offer:", err);
    }
}

//Signal Listener
socket.on("webrtc_signal", async data => {
    if (!peerConnection) return;

    if (data.type === "answer") {
        console.log("Received Answer");
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.payload));
        // Process queued ICE candidates
        pendingIce.forEach(c => peerConnection.addIceCandidate(new RTCIceCandidate(c)));
        pendingIce = [];
    }

    if (data.type === "ice") {
        if (peerConnection.remoteDescription) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.payload));
        } else {
            pendingIce.push(data.payload);
        }
    }
});

// ADMIN ACTIONS
function sendWarning(employeeId, employeeName) {
    const msg = prompt(`Send Warning to ${employeeName}:`, `Warning: High idle time detected.`);
    if (msg) {
        socket.emit("send_warning_to_employee", { employee_id: employeeId, message: msg });
        alert(`Warning sent.`);
    }
}

function requestScreenShare(employeeId, employeeName) {
    currentEmployeeId = employeeId;
    document.getElementById("employeeNameSpan").textContent = employeeName;
    document.getElementById("connectionStatus").textContent = "Waiting for employee approval...";
    document.getElementById("connectionStatus").className = "mt-3 text-danger";
    
    // Clear previous video
    const video = document.getElementById("remoteVideo");
    if(video.srcObject) { video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject = null; }

    new bootstrap.Modal(document.getElementById("screenShareModal")).show();

    socket.emit("request_screen_share", {
        employee_id: employeeId,
        message: "Admin requests screen sharing for verification."
    });
}

// Triggered when employee accepts the request
socket.on("screen_share_accepted_admin_notification", (data) => {
    console.log(`Employee ${data.employee_id} accepted.`);
    // Only start WebRTC if this is the employee we are currently looking at
    if (String(data.employee_id) === String(currentEmployeeId)) {
        startAdminWebRTC(currentEmployeeId);
    }
});

// DASHBOARD UPDATES

socket.on("admin_dashboard_update", data => {
    updateStatCards(data);
    updateRiskTable(data.employees_at_risk);
    updateAnomalyChart(); // Refresh chart on new data
});

function updateStatCards(data) {
    const stats = data.new_stats || data.stats;
    if(!stats) return;
    document.getElementById("critical-alerts-count").textContent = stats.critical_alerts;
    document.getElementById("active-employees-count").textContent = stats.active_employees;
    document.getElementById("avg-productivity-score").textContent = stats.avg_productivity.toFixed(1) + "%";
}

function updateRiskTable(newEmployees) {
    const tbody = document.getElementById("employee-risk-data");
    if (!tbody || !newEmployees) return;
    let html = "";
    newEmployees.forEach(emp => {
        const riskClass = emp.latest_risk_score >= 80 ? "text-danger" : emp.latest_risk_score >= 50 ? "text-warning" : "text-success";
        const bgClass = riskClass.replace("text", "bg");
        html += `
            <tr class="align-middle">
                <td><strong>${emp.name}</strong><br><small class='text-muted'>${emp.role}</small></td>
                <td>
                    <span class="fw-bold ${riskClass}">${Math.round(emp.latest_risk_score)}%</span>
                    <div class="progress mt-1" style="height:6px;"><div class="progress-bar ${bgClass}" style="width: ${emp.latest_risk_score}%;"></div></div>
                </td>
                <td><span class="badge ${emp.alert_level == 'High' ? 'bg-danger' : emp.alert_level == 'Medium' ? 'bg-warning text-dark' : 'bg-success'}">${emp.alert_level}</span></td>
                <td class="text-end">
                    <button onclick="sendWarning(${emp.id}, '${emp.name}')" class="btn btn-danger btn-sm me-2"><i class="bi bi-exclamation-triangle"></i></button>
                    <button onclick="requestScreenShare(${emp.id}, '${emp.name}')" class="btn btn-info btn-sm me-2"><i class="bi bi-display"></i></button>
                    <a href="/admin/employee/report/${emp.id}" class="btn btn-outline-secondary btn-sm">Report</a>
                </td>
            </tr>`;
    });
    tbody.innerHTML = html;
}

let anomalyChart = new Chart(document.getElementById("anomalyChart"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "Activity", data: [], borderColor: "#dc3545", backgroundColor: "rgba(220,53,69,0.15)", fill: true, tension: 0.4 }] },
    options: { plugins: { legend: { display: false } } }
});

function updateAnomalyChart() {
    fetch("/api/anomaly-data").then(r => r.json()).then(data => {
        anomalyChart.data.labels = data.hours;
        anomalyChart.data.datasets[0].data = data.activity;
        anomalyChart.update();
    });
}

document.addEventListener("DOMContentLoaded", () => {
    fetch("/api/admin/dashboard").then(r => r.json()).then(data => {
        updateStatCards(data);
        updateRiskTable(data.employees_at_risk);
    });
    updateAnomalyChart();
});
</script>
{% endblock %}
